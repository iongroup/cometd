!function(a,b){"function"==typeof define&&define.amd?define("cometd",[],function(){return a["org.cometd"]=b()}):"object"==typeof module&&module.exports?module.exports=b():a.cometd=b()}(this,function(){var a=void 0,b=void 0;return function(c,d){"object"==typeof b?module.exports=d():"function"==typeof a&&a.amd?a([],d):(c.org=c.org||{},c.org.cometd=d())}(this,function(){var a="undefined"!=typeof window?window:{},b={isString:function(a){return void 0!==a&&null!==a&&("string"==typeof a||a instanceof String)},isArray:function(a){return void 0!==a&&null!==a&&a instanceof Array},inArray:function(a,b){for(var c=0;c<b.length;++c)if(a===b[c])return c;return-1},setTimeout:function(b,c,d){return a.setTimeout(function(){try{b._debug("Invoking timed function",c),c()}catch(a){b._debug("Exception invoking timed function",c,a)}},d)},clearTimeout:function(b){a.clearTimeout(b)}},c=function(){var a=[],b={};this.getTransportTypes=function(){return a.slice(0)},this.findTransportTypes=function(c,d,e){for(var f=[],g=0;g<a.length;++g){var h=a[g];b[h].accept(c,d,e)===!0&&f.push(h)}return f},this.negotiateTransport=function(c,d,e,f){for(var g=0;g<a.length;++g)for(var h=a[g],i=0;i<c.length;++i)if(h===c[i]){var j=b[h];if(j.accept(d,e,f)===!0)return j}return null},this.add=function(c,d,e){for(var f=!1,g=0;g<a.length;++g)if(a[g]===c){f=!0;break}return f||("number"!=typeof e?a.push(c):a.splice(e,0,c),b[c]=d),!f},this.find=function(c){for(var d=0;d<a.length;++d)if(a[d]===c)return b[c];return null},this.remove=function(c){for(var d=0;d<a.length;++d)if(a[d]===c){a.splice(d,1);var e=b[c];return delete b[c],e}return null},this.clear=function(){a=[],b={}},this.reset=function(c){for(var d=0;d<a.length;++d)b[a[d]].reset(c)}},d=function(){var a,c,d;this.registered=function(b,d){a=b,c=d},this.unregistered=function(){a=null,c=null},this._debug=function(){c._debug.apply(c,arguments)},this._mixin=function(){return c._mixin.apply(c,arguments)},this.getConfiguration=function(){return c.getConfiguration()},this.getAdvice=function(){return c.getAdvice()},this.setTimeout=function(a,d){return b.setTimeout(c,a,d)},this.clearTimeout=function(a){b.clearTimeout(a)},this.convertToMessages=function(a){if(b.isString(a))try{return JSON.parse(a)}catch(c){throw this._debug("Could not convert to JSON the following string",'"'+a+'"'),new Error(c)}if(b.isArray(a))return a;if(void 0===a||null===a)return[];if(a instanceof Object)return[a];throw new Error("Conversion Error "+a+", typeof "+typeof a)},this.accept=function(a,b,c){throw new Error("Abstract")},this.getType=function(){return a},this.getURL=function(){return d},this.setURL=function(a){d=a},this.send=function(a,b){throw new Error("Abstract")},this.reset=function(b){this._debug("Transport",a,"reset",b?"initial":"retry")},this.abort=function(){this._debug("Transport",a,"aborted")},this.toString=function(){return this.getType()}};d.derive=function(a){function b(){}return b.prototype=a,new b};var e=function(){function c(a){for(;o.length>0;){var b=o[0],c=b[0],d=b[1];if(c.url!==a.url||c.sync!==a.sync)break;o.shift(),a.messages=a.messages.concat(c.messages),this._debug("Coalesced",c.messages.length,"messages from request",d.id)}}function e(a,b){if(this.transportSend(a,b),b.expired=!1,!a.sync){var c=this.getConfiguration().maxNetworkDelay,d=c;b.metaConnect===!0&&(d+=this.getAdvice().timeout),this._debug("Transport",this.getType(),"waiting at most",d,"ms for the response, maxNetworkDelay",c);var e=this;b.timeout=this.setTimeout(function(){b.expired=!0;var c="Request "+b.id+" of transport "+e.getType()+" exceeded "+d+" ms max network delay",f={reason:c},g=b.xhr;f.httpCode=e.xhrStatus(g),e.abortXHR(g),e._debug(c),e.complete(b,!1,b.metaConnect),a.onFailure(g,a.messages,f)},d)}}function f(a){var b=++l,c={id:b,metaConnect:!1,envelope:a};n.length<this.getConfiguration().maxConnections-1?(n.push(c),e.call(this,a,c)):(this._debug("Transport",this.getType(),"queueing request",b,"envelope",a),o.push([a,c]))}function g(a){var b=a.id;if(this._debug("Transport",this.getType(),"metaConnect complete, request",b),null!==m&&m.id!==b)throw new Error("Longpoll request mismatch, completing request "+b);m=null}function h(a,d){var e=b.inArray(a,n);if(e>=0&&n.splice(e,1),o.length>0){var g=o.shift(),h=g[0],i=g[1];if(this._debug("Transport dequeued request",i.id),d)this.getConfiguration().autoBatch&&c.call(this,h),f.call(this,h),this._debug("Transport completed request",a.id,h);else{var j=this;this.setTimeout(function(){j.complete(i,!1,i.metaConnect);var a={reason:"Previous request failed"},b=i.xhr;a.httpCode=j.xhrStatus(b),h.onFailure(b,h.messages,a)},0)}}}function i(a){if(null!==m)throw new Error("Concurrent metaConnect requests not allowed, request id="+m.id+" not yet completed");var b=++l;this._debug("Transport",this.getType(),"metaConnect send, request",b,"envelope",a);var c={id:b,metaConnect:!0,envelope:a};e.call(this,a,c),m=c}var j=new d,k=d.derive(j),l=0,m=null,n=[],o=[];return k.complete=function(a,b,c){c?g.call(this,a):h.call(this,a,b)},k.transportSend=function(a,b){throw new Error("Abstract")},k.transportSuccess=function(a,b,c){b.expired||(this.clearTimeout(b.timeout),this.complete(b,!0,b.metaConnect),c&&c.length>0?a.onSuccess(c):a.onFailure(b.xhr,a.messages,{httpCode:204}))},k.transportFailure=function(a,b,c){b.expired||(this.clearTimeout(b.timeout),this.complete(b,!1,b.metaConnect),a.onFailure(b.xhr,a.messages,c))},k.send=function(a,b){b?i.call(this,a):f.call(this,a)},k.abort=function(){j.abort();for(var a=0;a<n.length;++a){var b=n[a];b&&(this._debug("Aborting request",b),this.abortXHR(b.xhr)||this.transportFailure(b.envelope,b,{reason:"abort"}))}var c=m;c&&(this._debug("Aborting metaConnect request",c),this.abortXHR(c.xhr)||this.transportFailure(c.envelope,c,{reason:"abort"})),this.reset(!0)},k.reset=function(a){j.reset(a),m=null,n=[],o=[]},k.abortXHR=function(b){if(b)try{var c=b.readyState;return b.abort(),c!==a.XMLHttpRequest.UNSENT}catch(d){this._debug(d)}return!1},k.xhrStatus=function(a){if(a)try{return a.status}catch(b){this._debug(b)}return-1},k},f=function(){var b=new e,c=d.derive(b),f=!0;return c.accept=function(a,b,c){return f||!b},c.newXMLHttpRequest=function(){return new a.XMLHttpRequest},c.xhrSend=function(a){var b=c.newXMLHttpRequest();b.context=c.context,b.withCredentials=!0,b.open("POST",a.url,a.sync!==!0);var d=a.headers;if(d)for(var e in d)d.hasOwnProperty(e)&&b.setRequestHeader(e,d[e]);return b.setRequestHeader("Content-Type","application/json;charset=UTF-8"),b.onload=function(){200===b.status?a.onSuccess(b.responseText):a.onError(b.statusText)},b.onerror=function(){a.onError(b.statusText)},b.send(a.body),b},c.transportSend=function(a,b){this._debug("Transport",this.getType(),"sending request",b.id,"envelope",a);var c=this;try{var d=!0;b.xhr=this.xhrSend({transport:this,url:a.url,sync:a.sync,headers:this.getConfiguration().requestHeaders,body:JSON.stringify(a.messages),onSuccess:function(d){c._debug("Transport",c.getType(),"received response",d);var e=!1;try{var g=c.convertToMessages(d);0===g.length?(f=!1,c.transportFailure(a,b,{httpCode:204})):(e=!0,c.transportSuccess(a,b,g))}catch(h){if(c._debug(h),!e){f=!1;var i={exception:h};i.httpCode=c.xhrStatus(b.xhr),c.transportFailure(a,b,i)}}},onError:function(e,g){c._debug("Transport",c.getType(),"received error",e,g),f=!1;var h={reason:e,exception:g};h.httpCode=c.xhrStatus(b.xhr),d?c.setTimeout(function(){c.transportFailure(a,b,h)},0):c.transportFailure(a,b,h)}}),d=!1}catch(e){f=!1,this.setTimeout(function(){c.transportFailure(a,b,{exception:e})},0)}},c.reset=function(a){b.reset(a),f=!0},c},g=function(){function b(a,b,c){var d=this;return function(){d.transportFailure(a,b,"error",c)}}var c=new e,f=d.derive(c),g=0;return f.accept=function(a,b,c){return!0},f.jsonpSend=function(b){var c=document.getElementsByTagName("head")[0],d=document.createElement("script"),e="_cometd_jsonp_"+g++;a[e]=function(f){c.removeChild(d),delete a[e],b.onSuccess(f)};var f=b.url;f+=f.indexOf("?")<0?"?":"&",f+="jsonp="+e,f+="&message="+encodeURIComponent(b.body),d.src=f,d.async=b.sync!==!0,d.type="application/javascript",d.onerror=function(a){b.onError("jsonp "+a.type)},c.appendChild(d)},f.transportSend=function(a,c){for(var d=this,e=0,f=a.messages.length,g=[];f>0;){var h=JSON.stringify(a.messages.slice(e,e+f)),i=a.url.length+encodeURI(h).length,j=this.getConfiguration().maxURILength;if(i>j){if(1===f){var k="Bayeux message too big ("+i+" bytes, max is "+j+") for transport "+this.getType();return void this.setTimeout(b.call(this,a,c,k),0)}--f}else g.push(f),e+=f,f=a.messages.length-e}var l=a;if(g.length>1){var m=0,n=g[0];this._debug("Transport",this.getType(),"split",a.messages.length,"messages into",g.join(" + ")),l=this._mixin(!1,{},a),l.messages=a.messages.slice(m,n),l.onSuccess=a.onSuccess,l.onFailure=a.onFailure;for(var o=1;o<g.length;++o){var p=this._mixin(!1,{},a);m=n,n+=g[o],p.messages=a.messages.slice(m,n),p.onSuccess=a.onSuccess,p.onFailure=a.onFailure,this.send(p,c.metaConnect)}}this._debug("Transport",this.getType(),"sending request",c.id,"envelope",l);try{var q=!0;this.jsonpSend({transport:this,url:l.url,sync:l.sync,headers:this.getConfiguration().requestHeaders,body:JSON.stringify(l.messages),onSuccess:function(a){var b=!1;try{var e=d.convertToMessages(a);0===e.length?d.transportFailure(l,c,{httpCode:204}):(b=!0,d.transportSuccess(l,c,e))}catch(f){d._debug(f),b||d.transportFailure(l,c,{exception:f})}},onError:function(a,b){var e={reason:a,exception:b};q?d.setTimeout(function(){d.transportFailure(l,c,e)},0):d.transportFailure(l,c,e)}}),q=!1}catch(r){this.setTimeout(function(){d.transportFailure(l,c,{exception:r})},0)}},f},h=function(){function c(a,b){a&&(this.webSocketClose(a,b.code,b.reason),this.onClose(a,b))}function e(a){return a===p||a===o}function f(a,b,c){for(var d=[],e=0;e<b.messages.length;++e){var f=b.messages[e];f.id&&d.push(f.id)}a.envelopes[d.join(",")]=[b,c],this._debug("Transport",this.getType(),"stored envelope, envelopes",a.envelopes)}function g(b){if(!p){var d=j.getURL().replace(/^http/,"ws");this._debug("Transport",this.getType(),"connecting to URL",d);try{var f=j.getConfiguration().protocol;b.webSocket=f?new a.WebSocket(d,f):new a.WebSocket(d),p=b}catch(g){throw m=!1,this._debug("Exception while creating WebSocket object",g),new Error(g)}n=j.getConfiguration().stickyReconnect!==!1;var h=this,i=j.getConfiguration().connectTimeout;i>0&&(b.connectTimer=this.setTimeout(function(){j._debug("Transport",h.getType(),"timed out while connecting to URL",d,":",i,"ms"),c.call(h,b,{code:1e3,reason:"Connect Timeout"})},i));var k=function(){j._debug("WebSocket onopen",b),b.connectTimer&&h.clearTimeout(b.connectTimer),e(b)?(p=null,o=b,l.webSocketConnected=!0,h.onOpen(b)):(j._warn("Closing extra WebSocket connection",this,"active connection",o),c.call(h,b,{code:1e3,reason:"Extra Connection"}))},q=function(a){a=a||{code:1e3},j._debug("WebSocket onclose",b,a,"connecting",p,"current",o),b.connectTimer&&h.clearTimeout(b.connectTimer),h.onClose(b,a)},r=function(a){j._debug("WebSocket onmessage",a,b),h.onMessage(b,a)};b.webSocket.onopen=k,b.webSocket.onclose=q,b.webSocket.onerror=function(){q({code:1e3,reason:"Error"})},b.webSocket.onmessage=r,this._debug("Transport",this.getType(),"configured callbacks on",b)}}function h(a,b,d){var e=JSON.stringify(b.messages);a.webSocket.send(e),this._debug("Transport",this.getType(),"sent",b,"metaConnect =",d),this.onStat({tx:e.length});var f=this.getConfiguration().maxNetworkDelay,g=f;d&&(g+=this.getAdvice().timeout,q=!0);for(var h=this,i=[],k=0;k<b.messages.length;++k)!function(){var d=b.messages[k];d.id&&(i.push(d.id),a.timeouts[d.id]=h.setTimeout(function(){j._debug("Transport",h.getType(),"timing out message",d.id,"after",g,"on",a),c.call(h,a,{code:1e3,reason:"Message Timeout"})},g))}();this._debug("Transport",this.getType(),"waiting at most",g,"ms for messages",i,"maxNetworkDelay",f,", timeouts:",a.timeouts)}function i(a,b,d){try{null===a?(a=p||{envelopes:{},timeouts:{}},f.call(this,a,b,d),g.call(this,a)):(f.call(this,a,b,d),h.call(this,a,b,d))}catch(e){var i=this;this.setTimeout(function(){c.call(i,a,{code:1e3,reason:"Exception",exception:e})},0)}}var j,k=new d,l=d.derive(k),m=!0;l.webSocketConnected=!1;var n=!0,o=null,p=null,q=!1,r=null;return l.reset=function(a){k.reset(a),m=!0,a&&(l.webSocketConnected=!1),n=!0,o=null,p=null,q=!1},l._notifySuccess=function(a,b){a.call(this,b)},l._notifyFailure=function(a,b,c,d){a.call(this,b,c,d)},l.onOpen=function(a){var b=a.envelopes;this._debug("Transport",this.getType(),"opened",a,"pending messages",b);for(var c in b)if(b.hasOwnProperty(c)){var d=b[c],e=d[0],f=d[1];r=e.onSuccess,h.call(this,a,e,f)}},l.onMessage=function(a,c){this._debug("Transport",this.getType(),"received websocket message",c,a),this.onStat({rx:c.data&&c.data.length||0});for(var d=!1,e=this.convertToMessages(c.data),f=[],g=0;g<e.length;++g){var h=e[g];if((/^\/meta\//.test(h.channel)||void 0===h.data)&&h.id){f.push(h.id);var i=a.timeouts[h.id];i&&(this.clearTimeout(i),delete a.timeouts[h.id],this._debug("Transport",this.getType(),"removed timeout for message",h.id,", timeouts",a.timeouts))}"/meta/connect"===h.channel&&(q=!1),"/meta/disconnect"!==h.channel||q||(d=!0)}for(var j=!1,k=a.envelopes,l=0;l<f.length;++l){var m=f[l];for(var n in k)if(k.hasOwnProperty(n)){var o=n.split(","),p=b.inArray(m,o);if(p>=0){j=!0,o.splice(p,1);var s=k[n][0],t=k[n][1];delete k[n],o.length>0&&(k[o.join(",")]=[s,t]);break}}}j&&this._debug("Transport",this.getType(),"removed envelope, envelopes",k),this._notifySuccess(r,e),d&&this.webSocketClose(a,1e3,"Disconnect")},l.onClose=function(a,b){this._debug("Transport",this.getType(),"closed",a,b),e(a)&&(m=n&&l.webSocketConnected,p=null,o=null);var c=a.timeouts;a.timeouts={};for(var d in c)c.hasOwnProperty(d)&&this.clearTimeout(c[d]);var f=a.envelopes;a.envelopes={};for(var g in f)if(f.hasOwnProperty(g)){var h=f[g][0],i=f[g][1];i&&(q=!1);var j={websocketCode:b.code,reason:b.reason};b.exception&&(j.exception=b.exception),this._notifyFailure(h.onFailure,a,h.messages,j)}},l.registered=function(a,b){k.registered(a,b),j=b},l.accept=function(b,c,d){return this._debug("Transport",this.getType(),"accept, supported:",m),m&&!!a.WebSocket&&j.websocketEnabled!==!1},l.send=function(a,b){this._debug("Transport",this.getType(),"sending",a,"metaConnect =",b),i.call(this,o,a,b)},l.webSocketClose=function(a,b,c){try{a.webSocket&&a.webSocket.close(b,c)}catch(d){this._debug(d)}},l.abort=function(){k.abort(),c.call(this,o,{code:1e3,reason:"Abort"}),this.reset(!0)},l.onStat=function(a){},l},i=function(d,e){function i(a,b){try{return a[b]}catch(c){return}}function j(a){return b.isString(a)}function k(a){return void 0!==a&&null!==a&&"function"==typeof a}function l(a,b){for(var c="";--b>0&&!(a>=Math.pow(10,b));)c+="0";return c+=a}function m(b,c){if(a.console){var d=a.console[b];if(k(d)){var e=new Date;[].splice.call(c,0,0,l(e.getHours(),2)+":"+l(e.getMinutes(),2)+":"+l(e.getSeconds(),2)+"."+l(e.getMilliseconds(),3)),d.apply(a.console,c)}}}function n(a){return/(^https?:\/\/)?(((\[[^\]]+\])|([^:\/\?#]+))(:(\d+))?)?([^\?#]*)(.*)?/.exec(a)}function o(a){ra._debug("Configuring cometd object with",a),j(a)&&(a={url:a}),a||(a={}),Na=ra._mixin(!1,Na,a);var b=ra.getURL();if(!b)throw new Error("Missing required configuration parameter 'url' specifying the Bayeux server URL");var c=n(b),d=c[2],e=c[8],f=c[9];if(ta=ra._isCrossDomain(d),Na.appendMessageTypeToURL)if(void 0!==f&&f.length>0)ra._info("Appending message type to URI "+e+f+" is not supported, disabling 'appendMessageTypeToURL' configuration"),Na.appendMessageTypeToURL=!1;else{var g=e.split("/"),h=g.length-1;e.match(/\/$/)&&(h-=1),g[h].indexOf(".")>=0&&(ra._info("Appending message type to URI "+e+" is not supported, disabling 'appendMessageTypeToURL' configuration"),Na.appendMessageTypeToURL=!1)}}function p(a){if(a){var b=Ca[a.channel];b&&b[a.id]&&(delete b[a.id],ra._debug("Removed",a.listener?"listener":"subscription",a))}}function q(a){a&&!a.listener&&p(a)}function r(){for(var a in Ca)if(Ca.hasOwnProperty(a)){var b=Ca[a];if(b)for(var c in b)b.hasOwnProperty(c)&&q(b[c])}}function s(a){va!==a&&(ra._debug("Status",va,"->",a),va=a)}function t(){return"disconnecting"===va||"disconnected"===va}function u(){var a=++wa;return""+a}function v(a,b,c,d,e){try{return b.call(a,d)}catch(f){var g=ra.onExtensionException;if(k(g)){ra._debug("Invoking extension exception handler",c,f);try{g.call(ra,f,c,e,d)}catch(h){ra._info("Exception during execution of extension exception handler",c,h)}}else ra._info("Exception during execution of extension",c,f);return d}}function w(a){for(var b=0;b<Fa.length&&(void 0!==a&&null!==a);++b){var c=Fa[b],d=c.extension.incoming;if(k(d)){var e=v(c.extension,d,c.name,a,!1);a=void 0===e?a:e}}return a}function x(a){for(var b=Fa.length-1;b>=0&&(void 0!==a&&null!==a);--b){var c=Fa[b],d=c.extension.outgoing;if(k(d)){var e=v(c.extension,d,c.name,a,!0);a=void 0===e?a:e}}return a}function y(a,b){var c=Ca[a];if(c)for(var d in c)if(c.hasOwnProperty(d)){var e=c[d];if(e)try{e.callback.call(e.scope,b)}catch(f){var g=ra.onListenerException;if(k(g)){ra._debug("Invoking listener exception handler",e,f);try{g.call(ra,f,e,e.listener,b)}catch(h){ra._info("Exception during execution of listener exception handler",e,h)}}else ra._info("Exception during execution of listener",e,b,f)}}}function z(a,b){y(a,b);for(var c=a.split("/"),d=c.length-1,e=d;e>0;--e){var f=c.slice(0,e).join("/")+"/*";e===d&&y(f,b),f+="*",y(f,b)}}function A(){null!==Ea&&b.clearTimeout(Ea),Ea=null}function B(a,c){A();var d=Ga.interval+c;ra._debug("Function scheduled in",d,"ms, interval =",Ga.interval,"backoff =",Da,a),Ea=b.setTimeout(ra,a,d)}function C(a,b,c,d){for(var e=0;e<b.length;++e){var f=b[e],g=f.id;xa&&(f.clientId=xa),f=x(f),void 0!==f&&null!==f?(f.id=g,b[e]=f):(delete Ha[g],b.splice(e--,1))}if(0!==b.length){var h=ra.getURL();Na.appendMessageTypeToURL&&(h.match(/\/$/)||(h+="/"),d&&(h+=d));var i={url:h,sync:a,messages:b,onSuccess:function(a){try{Oa.call(ra,a)}catch(b){ra._info("Exception during handling of messages",b)}},onFailure:function(a,b,c){try{var d=ra.getTransport();c.connectionType=d?d.getType():"unknown",Pa.call(ra,a,b,c)}catch(e){ra._info("Exception during handling of failure",e)}}};ra._debug("Send",i),oa.send(i,c)}}function D(a){ya>0||Aa===!0?za.push(a):C(!1,[a],!1)}function E(){Da=0}function F(){return Da<Na.maxBackoff&&(Da+=Na.backoffIncrement),Da}function G(){++ya,ra._debug("Starting batch, depth",ya)}function H(){var a=za;za=[],a.length>0&&C(!1,a,!1)}function I(){if(--ya,ra._debug("Ending batch, depth",ya),ya<0)throw new Error("Calls to startBatch() and endBatch() are not paired");0!==ya||t()||Aa||H()}function J(){if(!t()){var a={id:u(),channel:"/meta/connect",connectionType:oa.getType()};Ka||(a.advice={timeout:0}),s("connecting"),ra._debug("Connect sent",a),C(!1,[a],!0,"connect"),s("connected")}}function K(a){s("connecting"),B(function(){J()},a)}function L(a){a&&(Ga=ra._mixin(!1,{},Na.advice,a),ra._debug("New advice",Ga))}function M(a){if(A(),a&&oa&&oa.abort(),xa=null,s("disconnected"),ya=0,E(),oa=null,Ja=!1,Ka=!1,za.length>0){var b=za;za=[],Pa.call(ra,void 0,b,{reason:"Disconnected"})}}function N(a,b,c){var d=ra.onTransportException;if(k(d)){ra._debug("Invoking transport exception handler",a,b,c);try{d.call(ra,c,a,b)}catch(e){ra._info("Exception during execution of transport exception handler",e)}}}function O(a,b){k(a)&&(b=a,a=void 0),xa=null,r(),t()&&ua.reset(!0),L({}),ya=0,Aa=!0,pa=a,qa=b;var c="1.0",d=ra.getURL(),e=ua.findTransportTypes(c,ta,d),f={id:u(),version:c,minimumVersion:c,channel:"/meta/handshake",supportedConnectionTypes:e,advice:{timeout:Ga.timeout,interval:Ga.interval}},g=ra._mixin(!1,{},pa,f);if(ra._putCallback(g.id,b),!oa&&(oa=ua.negotiateTransport(e,c,ta,d),!oa)){var h="Could not find initial transport among: "+ua.getTransportTypes();throw ra._warn(h),new Error(h)}ra._debug("Initial transport is",oa.getType()),s("handshaking"),ra._debug("Handshake sent",g),C(!1,[g],!1,"handshake")}function P(a){s("handshaking"),Aa=!0,B(function(){O(pa,qa)},a)}function Q(a,b){try{a.call(ra,b)}catch(c){var d=ra.onCallbackException;if(k(d)){ra._debug("Invoking callback exception handler",c);try{d.call(ra,c,b)}catch(e){ra._info("Exception during execution of callback exception handler",e)}}else ra._info("Exception during execution of message callback",c)}}function R(a){var b=ra._getCallback([a.id]);k(b)&&(delete Ha[a.id],Q(b,a))}function S(a){var c=Ia[a.id];if(delete Ia[a.id],c){ra._debug("Handling remote call response for",a,"with context",c);var d=c.timeout;d&&b.clearTimeout(d);var e=c.callback;if(k(e))return Q(e,a),!0}return!1}function T(a){ra._debug("Transport failure handling",a),a.transport&&(oa=a.transport),a.url&&oa.setURL(a.url);var b=a.action,c=a.delay||0;switch(b){case"handshake":P(c);break;case"retry":K(c);break;case"none":M(!0);break;default:throw new Error("Unknown action "+b)}}function U(a,b){R(a),z("/meta/handshake",a),z("/meta/unsuccessful",a),t()&&(b.action="none"),ra.onTransportFailure.call(ra,a,b,T)}function V(a){var b=ra.getURL();if(a.successful){var c=ra._isCrossDomain(n(b)[2]),d=ua.negotiateTransport(a.supportedConnectionTypes,a.version,c,b);if(null===d)return a.successful=!1,void U(a,{cause:"negotiation",action:"none",transport:null});oa!==d&&(ra._debug("Transport",oa.getType(),"->",d.getType()),oa=d),xa=a.clientId,Aa=!1,H(),a.reestablish=Ja,Ja=!0,R(a),z("/meta/handshake",a),Ma=a["x-messages"]||0;var e=t()?"none":Ga.reconnect||"retry";switch(e){case"retry":E(),0===Ma?K(0):ra._debug("Processing",Ma,"handshake-delivered messages");break;case"none":M(!0);break;default:throw new Error("Unrecognized advice action "+e)}}else U(a,{cause:"unsuccessful",action:Ga.reconnect||"handshake",transport:oa})}function W(a){U(a,{cause:"failure",action:"handshake",transport:null})}function X(a,b){z("/meta/connect",a),z("/meta/unsuccessful",a),t()&&(b.action="none"),ra.onTransportFailure.call(ra,a,b,T)}function Y(a){if(Ka=a.successful){z("/meta/connect",a);var b=t()?"none":Ga.reconnect||"retry";switch(b){case"retry":E(),K(Da);break;case"none":M(!1);break;default:throw new Error("Unrecognized advice action "+b)}}else X(a,{cause:"unsuccessful",action:Ga.reconnect||"retry",transport:oa})}function Z(a){Ka=!1,X(a,{cause:"failure",action:"retry",transport:null})}function $(a){M(!0),R(a),z("/meta/disconnect",a),z("/meta/unsuccessful",a)}function _(a){a.successful?(M(!1),R(a),z("/meta/disconnect",a)):$(a)}function aa(a){$(a)}function ba(a){var b=Ca[a.subscription];if(b)for(var c in b)if(b.hasOwnProperty(c)){var d=b[c];d&&!d.listener&&(delete b[c],ra._debug("Removed failed subscription",d))}R(a),z("/meta/subscribe",a),z("/meta/unsuccessful",a)}function ca(a){a.successful?(R(a),z("/meta/subscribe",a)):ba(a)}function da(a){ba(a)}function ea(a){R(a),z("/meta/unsubscribe",a),z("/meta/unsuccessful",a)}function fa(a){a.successful?(R(a),z("/meta/unsubscribe",a)):ea(a)}function ga(a){ea(a)}function ha(a){S(a)||(R(a),z("/meta/publish",a),z("/meta/unsuccessful",a))}function ia(a){void 0!==a.data?S(a)||(z(a.channel,a),Ma>0&&(--Ma,0===Ma&&(ra._debug("Processed last handshake-delivered message"),K(0)))):void 0===a.successful?ra._warn("Unknown Bayeux Message",a):a.successful?(R(a),z("/meta/publish",a)):ha(a)}function ja(a){ha(a)}function ka(a){if(La=0,a=w(a),void 0!==a&&null!==a){L(a.advice);var b=a.channel;switch(b){case"/meta/handshake":V(a);break;case"/meta/connect":Y(a);break;case"/meta/disconnect":_(a);break;case"/meta/subscribe":ca(a);break;case"/meta/unsubscribe":fa(a);break;default:ia(a)}}}function la(a){var b=Ca[a];if(b)for(var c in b)if(b.hasOwnProperty(c)&&b[c])return!0;return!1}function ma(a,b){var c={scope:a,method:b};if(k(a))c.scope=void 0,c.method=a;else if(j(b)){if(!a)throw new Error("Invalid scope "+a);if(c.method=a[b],!k(c.method))throw new Error("Invalid callback "+b+" for scope "+a)}else if(!k(b))throw new Error("Invalid callback "+b);return c}function na(a,b,c,d){var e=ma(b,c);ra._debug("Adding",d?"listener":"subscription","on",a,"with scope",e.scope,"and callback",e.method);var f=++Ba,g={id:f,channel:a,scope:e.scope,callback:e.method,listener:d},h=Ca[a];return h||(h={},Ca[a]=h),h[f]=g,ra._debug("Added",d?"listener":"subscription",g),g}var oa,pa,qa,ra=this,sa=d||"default",ta=!1,ua=new c,va="disconnected",wa=0,xa=null,ya=0,za=[],Aa=!1,Ba=0,Ca={},Da=0,Ea=null,Fa=[],Ga={},Ha={},Ia={},Ja=!1,Ka=!1,La=0,Ma=0;e&&"undefined"!==e.glob&&(a=e.glob);var Na={protocol:null,stickyReconnect:!0,connectTimeout:0,maxConnections:2,backoffIncrement:1e3,maxBackoff:6e4,logLevel:"info",maxNetworkDelay:1e4,requestHeaders:{},appendMessageTypeToURL:!0,autoBatch:!1,urls:{},maxURILength:2e3,advice:{timeout:6e4,interval:0,reconnect:void 0,maxInterval:0}};this._mixin=function(a,b,c){for(var d=b||{},e=2;e<arguments.length;++e){var f=arguments[e];if(void 0!==f&&null!==f)for(var g in f)if(f.hasOwnProperty(g)){var h=i(f,g),j=i(d,g);if(h===b)continue;if(void 0===h)continue;if(a&&"object"==typeof h&&null!==h)if(h instanceof Array)d[g]=this._mixin(a,j instanceof Array?j:[],h);else{var k="object"!=typeof j||j instanceof Array?{}:j;d[g]=this._mixin(a,k,h)}else d[g]=h}}return d},this._warn=function(){m("warn",arguments)},this._info=function(){"warn"!==Na.logLevel&&m("info",arguments)},this._debug=function(){"debug"===Na.logLevel&&m("debug",arguments)},this._isCrossDomain=function(b){return!!(a.location&&a.location.host&&b)&&b!==a.location.host};var Oa,Pa;this.send=D,this._getCallback=function(a){return Ha[a]},this._putCallback=function(a,b){var c=this._getCallback(a);return k(b)&&(Ha[a]=b),c},this.onTransportFailure=function(a,b,c){this._debug("Transport failure",b,"for",a);var d=this.getTransportRegistry(),e=this.getURL(),f=this._isCrossDomain(n(e)[2]),g="1.0",h=d.findTransportTypes(g,f,e);if("none"===b.action){if("/meta/handshake"===a.channel&&!b.transport){var i="Could not negotiate transport, client=["+h+"], server=["+a.supportedConnectionTypes+"]";this._warn(i),oa&&N(oa.getType(),null,{reason:i,connectionType:oa.getType(),transport:oa})}}else if(b.delay=this.getBackoffPeriod(),"/meta/handshake"===a.channel){if(!b.transport){var j=d.negotiateTransport(h,g,f,e);j?(oa&&(this._debug("Transport",oa.getType(),"->",j.getType()),N(oa.getType(),j.getType(),a.failure)),b.action="handshake",b.transport=j):(this._warn("Could not negotiate transport, client=["+h+"]"),oa&&N(oa.getType(),null,a.failure),b.action="none")}"none"!==b.action&&this.increaseBackoffPeriod()}else{var k=(new Date).getTime();if(0===La&&(La=k),"retry"===b.action){b.delay=this.increaseBackoffPeriod();var l=Ga.maxInterval;if(l>0){var m=Ga.timeout+Ga.interval+l,o=k-La;o+Da>m&&(b.action="handshake")}}"handshake"===b.action&&(b.delay=0,d.reset(!1),this.resetBackoffPeriod())}c.call(ra,b)},this.receive=ka,Oa=function(a){ra._debug("Received",a);for(var b=0;b<a.length;++b){var c=a[b];ka(c)}},Pa=function(a,b,c){ra._debug("handleFailure",a,b,c),c.transport=a;for(var d=0;d<b.length;++d){var e=b[d],f={id:e.id,successful:!1,channel:e.channel,failure:c};switch(c.message=e,e.channel){case"/meta/handshake":W(f);break;case"/meta/connect":Z(f);break;case"/meta/disconnect":aa(f);break;case"/meta/subscribe":f.subscription=e.subscription,da(f);break;case"/meta/unsubscribe":f.subscription=e.subscription,ga(f);break;default:ja(f)}}},this.registerTransport=function(a,b,c){var d=ua.add(a,b,c);return d&&(this._debug("Registered transport",a),k(b.registered)&&b.registered(a,this)),d},this.unregisterTransport=function(a){var b=ua.remove(a);return null!==b&&(this._debug("Unregistered transport",a),k(b.unregistered)&&b.unregistered()),b},this.unregisterTransports=function(){ua.clear()},this.getTransportTypes=function(){return ua.getTransportTypes()},this.findTransport=function(a){return ua.find(a)},this.getTransportRegistry=function(){return ua},this.configure=function(a){o.call(this,a)},this.init=function(a,b){this.configure(a),this.handshake(b)},this.handshake=function(a,b){if("disconnected"!==va)throw new Error("Illegal state: handshaken");O(a,b)},this.disconnect=function(a,b,c){if(t())return void(c&&c());"boolean"!=typeof a&&(c=b,b=a,a=!1),k(b)&&(c=b,b=void 0);var d={id:u(),channel:"/meta/disconnect"},e=this._mixin(!1,{},b,d);ra._putCallback(e.id,c),s("disconnecting"),C(a===!0,[e],!1,"disconnect")},this.startBatch=function(){G()},this.endBatch=function(){I()},this.batch=function(a,b){var c=ma(a,b);this.startBatch();try{c.method.call(c.scope),this.endBatch()}catch(d){throw this._info("Exception during execution of batch",d),this.endBatch(),new Error(d)}},this.addListener=function(a,b,c){if(arguments.length<2)throw new Error("Illegal arguments number: required 2, got "+arguments.length);if(!j(a))throw new Error("Illegal argument type: channel must be a string");return na(a,b,c,!0)},this.removeListener=function(a){if(!(a&&a.channel&&"id"in a))throw new Error("Invalid argument: expected subscription, not "+a);p(a)},this.clearListeners=function(){Ca={}},this.subscribe=function(a,b,c,d,e){if(arguments.length<2)throw new Error("Illegal arguments number: required 2, got "+arguments.length);if(!j(a))throw new Error("Illegal argument type: channel must be a string");if(t())throw new Error("Illegal state: disconnected");k(b)&&(e=d,d=c,c=b,b=void 0),k(d)&&(e=d,d=void 0);var f=!la(a),g=na(a,b,c,!1);if(f){var h={id:u(),channel:"/meta/subscribe",subscription:a},i=this._mixin(!1,{},d,h);ra._putCallback(i.id,e),D(i)}return g},this.unsubscribe=function(a,b,c){if(arguments.length<1)throw new Error("Illegal arguments number: required 1, got "+arguments.length);if(t())throw new Error("Illegal state: disconnected");k(b)&&(c=b,b=void 0),this.removeListener(a);var d=a.channel;if(!la(d)){var e={id:u(),channel:"/meta/unsubscribe",subscription:d},f=this._mixin(!1,{},b,e);ra._putCallback(f.id,c),D(f)}},this.resubscribe=function(a,b){if(q(a),a)return this.subscribe(a.channel,a.scope,a.callback,b)},this.clearSubscriptions=function(){r()},this.publish=function(a,b,c,d){if(arguments.length<1)throw new Error("Illegal arguments number: required 1, got "+arguments.length);if(!j(a))throw new Error("Illegal argument type: channel must be a string");if(/^\/meta\//.test(a))throw new Error("Illegal argument: cannot publish to meta channels");if(t())throw new Error("Illegal state: disconnected");k(b)?(d=b,b={},c=void 0):k(c)&&(d=c,c=void 0);var e={id:u(),channel:a,data:b},f=this._mixin(!1,{},c,e);ra._putCallback(f.id,d),D(f)},this.publishBinary=function(a,b,c,d,e){k(b)?(e=b,b=new ArrayBuffer(0),c=!0,d=void 0):k(c)?(e=c,c=!0,d=void 0):k(d)&&(e=d,d=void 0);var f={meta:d,data:b,last:c},g={ext:{binary:{}}};this.publish(a,f,g,e)},this.remoteCall=function(a,c,d,e,f){if(arguments.length<1)throw new Error("Illegal arguments number: required 1, got "+arguments.length);if(!j(a))throw new Error("Illegal argument type: target must be a string");if(t())throw new Error("Illegal state: disconnected");if(k(c)?(f=c,c={},d=Na.maxNetworkDelay,e=void 0):k(d)?(f=d,d=Na.maxNetworkDelay,e=void 0):k(e)&&(f=e,e=void 0),"number"!=typeof d)throw new Error("Illegal argument type: timeout must be a number");a.match(/^\//)||(a="/"+a);var g="/service"+a,h={id:u(),channel:g,data:c},i=this._mixin(!1,{},e,h),l={callback:f};d>0&&(l.timeout=b.setTimeout(ra,function(){ra._debug("Timing out remote call",i,"after",d,"ms"),ha({id:i.id,error:"406::timeout",successful:!1,failure:{message:i,reason:"Remote Call Timeout"}})},d),ra._debug("Scheduled remote call timeout",i,"in",d,"ms")),Ia[i.id]=l,D(i)},this.remoteCallBinary=function(a,b,c,d,e,f){k(b)?(f=b,b=new ArrayBuffer(0),c=!0,d=void 0,e=Na.maxNetworkDelay):k(c)?(f=c,c=!0,d=void 0,e=Na.maxNetworkDelay):k(d)?(f=d,d=void 0,e=Na.maxNetworkDelay):k(e)&&(f=e,e=Na.maxNetworkDelay);var g={meta:d,data:b,last:c},h={ext:{binary:{}}};this.remoteCall(a,g,e,h,f)},this.getStatus=function(){return va},this.isDisconnected=t,this.setBackoffIncrement=function(a){Na.backoffIncrement=a},this.getBackoffIncrement=function(){return Na.backoffIncrement},this.getBackoffPeriod=function(){return Da},this.increaseBackoffPeriod=function(){return F()},this.resetBackoffPeriod=function(){
E()},this.setLogLevel=function(a){Na.logLevel=a},this.registerExtension=function(a,b){if(arguments.length<2)throw new Error("Illegal arguments number: required 2, got "+arguments.length);if(!j(a))throw new Error("Illegal argument type: extension name must be a string");for(var c=!1,d=0;d<Fa.length;++d){var e=Fa[d];if(e.name===a){c=!0;break}}return c?(this._info("Could not register extension with name",a,"since another extension with the same name already exists"),!1):(Fa.push({name:a,extension:b}),this._debug("Registered extension",a),k(b.registered)&&b.registered(a,this),!0)},this.unregisterExtension=function(a){if(!j(a))throw new Error("Illegal argument type: extension name must be a string");for(var b=!1,c=0;c<Fa.length;++c){var d=Fa[c];if(d.name===a){Fa.splice(c,1),b=!0,this._debug("Unregistered extension",a);var e=d.extension;k(e.unregistered)&&e.unregistered();break}}return b},this.getExtension=function(a){for(var b=0;b<Fa.length;++b){var c=Fa[b];if(c.name===a)return c.extension}return null},this.getName=function(){return sa},this.getClientId=function(){return xa},this.getURL=function(){if(oa){var a=oa.getURL();if(a)return a;if(a=Na.urls[oa.getType()])return a}return Na.url},this.getTransport=function(){return oa},this.getConfiguration=function(){return this._mixin(!0,{},Na)},this.getAdvice=function(){return this._mixin(!0,{},Ga)},e&&e.noDefaultTransports||(a.WebSocket&&this.registerTransport("websocket",new h),this.registerTransport("long-polling",new f),this.registerTransport("callback-polling",new g))},j=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z",".","-",":","+","=","^","!","/","*","?","&","<",">","(",")","[","]","{","}","@","%","$","#"],k=[0,68,0,84,83,82,72,0,75,76,70,65,0,63,62,69,0,1,2,3,4,5,6,7,8,9,64,0,73,66,74,71,81,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,77,0,78,67,0,0,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,79,0,80,0,0],l={encode:function(a){var b=null;if(a instanceof ArrayBuffer?b=a:a.buffer instanceof ArrayBuffer?b=a.buffer:Array.isArray(a)&&(b=new Uint8Array(a).buffer),null==b)throw new Error("Cannot Z85 encode "+a);for(var c=b.byteLength,d=c%4,e=4-(0===d?4:d),f=new DataView(b),g="",h=0,i=0;i<c+e;++i){var k=i>=c;if(h=256*h+(k?0:f.getUint8(i)),(i+1)%4===0){for(var l=52200625,m=5;m>0;--m){if(!k||m>e){var n=Math.floor(h/l)%85;g+=j[n]}l/=85}h=0}}return g},decode:function(a){for(var b=a.length%5,c=5-(0===b?5:b),d=0;d<c;++d)a+=j[j.length-1];for(var e=a.length,f=new ArrayBuffer(4*e/5-c),g=new DataView(f),h=0,i=0,l=0,m=0;m<e;++m){var n=a.charCodeAt(i++)-32;if(h=85*h+k[n],i%5===0){for(var o=16777216;o>=1;)l<g.byteLength&&g.setUint8(l++,Math.floor(h/o)%256),o/=256;h=0}}return f}};return{CometD:i,Transport:d,RequestTransport:e,LongPollingTransport:f,CallbackPollingTransport:g,WebSocketTransport:h,Utils:b,Z85:l}}),function(c,d){"object"==typeof b?module.exports=d(require("./cometd")):"function"==typeof a&&a.amd?a(["./cometd"],d):d(c.org.cometd)}(this,function(a){return a.AckExtension=function(){function a(a,c){b._debug(a,c)}var b,c,d=!1;this.registered=function(c,d){b=d,a("AckExtension: executing registration callback")},this.unregistered=function(){a("AckExtension: executing unregistration callback"),b=null},this.incoming=function(b){var e=b.channel,f=b.ext;if("/meta/handshake"===e){if(f){var g=f.ack;if("object"==typeof g){d=g.enabled===!0;var h=g.batch;"number"==typeof h&&(c=h)}else d=g===!0}a("AckExtension: server supports acknowledgements",d)}else"/meta/connect"===e&&b.successful&&d&&f&&"number"==typeof f.ack&&(c=f.ack,a("AckExtension: server sent batch",c));return b},this.outgoing=function(e){var f=e.channel;return e.ext||(e.ext={}),"/meta/handshake"===f?(e.ext.ack=b&&b.ackEnabled!==!1,d=!1,c=0):"/meta/connect"===f&&d&&(e.ext.ack=c,a("AckExtension: client sending batch",c)),e}}}),function(c,d){"object"==typeof b?module.exports=d(require("./cometd")):"function"==typeof a&&a.amd?a(["./cometd"],d):d(c.org.cometd)}(this,function(a){return a.TimeSyncExtension=function(b){function c(a,b){d._debug(a,b)}var d,e=b&&b.maxSamples||10,f=[],g=[],h=0,i=0;this.registered=function(a,b){d=b,c("TimeSyncExtension: executing registration callback")},this.unregistered=function(){c("TimeSyncExtension: executing unregistration callback"),d=null,f=[],g=[]},this.incoming=function(a){var b=a.channel;if(b&&0===b.indexOf("/meta/")&&a.ext&&a.ext.timesync){var d=a.ext.timesync;c("TimeSyncExtension: server sent timesync",d);var j=(new Date).getTime(),k=(j-d.tc-d.p)/2,l=d.ts-d.tc-k;f.push(k),g.push(l),g.length>e&&(g.shift(),f.shift());for(var m=g.length,n=0,o=0,p=0;p<m;++p)n+=f[p],o+=g[p];h=parseInt((n/m).toFixed()),i=parseInt((o/m).toFixed()),c("TimeSyncExtension: network lag",h,"ms, time offset with server",i,"ms",h,i)}return a},this.outgoing=function(a){var b=a.channel;return b&&0===b.indexOf("/meta/")&&(a.ext||(a.ext={}),a.ext.timesync={tc:(new Date).getTime(),l:h,o:i},c("TimeSyncExtension: client sending timesync",a.ext.timesync)),a},this.getTimeOffset=function(){return i},this.getTimeOffsetSamples=function(){return g},this.getNetworkLag=function(){return h},this.getServerTime=function(){return(new Date).getTime()+i},this.getServerDate=function(){return new Date(this.getServerTime())},this.setTimeout=function(b,c){var e=c instanceof Date?c.getTime():0+c,f=e-i,g=f-(new Date).getTime();return g<=0&&(g=1),a.Utils.setTimeout(d,b,g)}}}),function(c,d){"object"==typeof b?module.exports=d(require("./cometd")):"function"==typeof a&&a.amd?a(["./cometd"],d):d(c.org.cometd)}(this,function(a){return a.BinaryExtension=function(){this.incoming=function(b){if(!/^\/meta\//.test(b.channel)){var c=b.ext;if(c){var d=c.binary;d&&(b.data.data=a.Z85.decode(b.data.data))}}return b},this.outgoing=function(b){if(!/^\/meta\//.test(b.channel)){var c=b.ext;if(c){var d=c.binary;d&&(b.data.data=a.Z85.encode(b.data.data))}}return b}}}),org.cometd});