!function(e,t){void 0===e&&void 0!==window&&(e=window),"function"==typeof define&&define.amd?define("cometd",[],function(){return e.cometd=t()}):"object"==typeof module&&module.exports?module.exports=t():e.cometd=t()}(this,function(){var e,t,n,r,i,o,s,a,c=void 0;return e=this,t=function(){function me(){var c=[],u={};this.getTransportTypes=function(){return c.slice(0)},this.findTransportTypes=function(e,t,n){for(var r=[],i=0;i<c.length;++i){var o=c[i];!0===u[o].accept(e,t,n)&&r.push(o)}return r},this.negotiateTransport=function(e,t,n,r){for(var i=0;i<c.length;++i)for(var o=c[i],s=0;s<e.length;++s)if(o===e[s]){var a=u[o];if(!0===a.accept(t,n,r))return a}return null},this.add=function(e,t,n){for(var r=!1,i=0;i<c.length;++i)if(c[i]===e){r=!0;break}return r||("number"!=typeof n?c.push(e):c.splice(n,0,e),u[e]=t),!r},this.find=function(e){for(var t=0;t<c.length;++t)if(c[t]===e)return u[e];return null},this.remove=function(e){for(var t=0;t<c.length;++t)if(c[t]===e){c.splice(t,1);var n=u[e];return delete u[e],n}return null},this.clear=function(){c=[],u={}},this.reset=function(e){for(var t=0;t<c.length;++t)u[c[t]].reset(e)}}function v(){var n,r,t;this.registered=function(e,t){n=e,r=t},this.unregistered=function(){r=n=null},this._debug=function(){r._debug.apply(r,arguments)},this._mixin=function(){return r._mixin.apply(r,arguments)},this.getConfiguration=function(){return r.getConfiguration()},this.getAdvice=function(){return r.getAdvice()},this.setTimeout=function(e,t){return be.setTimeout(r,e,t)},this.clearTimeout=function(e){be.clearTimeout(e)},this.convertToMessages=function(t){if(be.isString(t))try{return JSON.parse(t)}catch(e){throw this._debug("Could not convert to JSON the following string",'"'+t+'"'),new Error(e)}if(be.isArray(t))return t;if(null==t)return[];if(t instanceof Object)return[t];throw new Error("Conversion Error "+t+", typeof "+typeof t)},this.accept=function(e,t,n){throw new Error("Abstract")},this.getType=function(){return n},this.getURL=function(){return t},this.setURL=function(e){t=e},this.send=function(e,t){throw new Error("Abstract")},this.reset=function(e){this._debug("Transport",n,"reset",e?"initial":"retry")},this.abort=function(){this._debug("Transport",n,"aborted")},this.toString=function(){return this.getType()}}var ve="undefined"!=typeof window?window:{},be={isString:function(e){return null!=e&&("string"==typeof e||e instanceof String)},isArray:function(e){return null!=e&&e instanceof Array},inArray:function(e,t){for(var n=0;n<t.length;++n)if(e===t[n])return n;return-1},setTimeout:function(t,n,e){return ve.setTimeout(function(){try{t._debug("Invoking timed function",n),n()}catch(e){t._debug("Exception invoking timed function",n,e)}},e)},clearTimeout:function(e){ve.clearTimeout(e)}};v.derive=function(e){function t(){}return t.prototype=e,new t};function n(){var r=new v,e=v.derive(r),i=0,o=null,a=[],c=[];function s(r,i){var e,o,s;this.transportSend(r,i),i.expired=!1,r.sync||(e=this.getConfiguration().maxNetworkDelay,o=e,!0===i.metaConnect&&(o+=this.getAdvice().timeout),this._debug("Transport",this.getType(),"waiting at most",o,"ms for the response, maxNetworkDelay",e),s=this,i.timeout=this.setTimeout(function(){i.expired=!0;var e="Request "+i.id+" of transport "+s.getType()+" exceeded "+o+" ms max network delay",t={reason:e},n=i.xhr;t.httpCode=s.xhrStatus(n),s.abortXHR(n),s._debug(e),s.complete(i,!1,i.metaConnect),r.onFailure(n,r.messages,t)},o))}function u(e){var t=++i,n={id:t,metaConnect:!1,envelope:e};a.length<this.getConfiguration().maxConnections-1?(a.push(n),s.call(this,e,n)):(this._debug("Transport",this.getType(),"queueing request",t,"envelope",e),c.push([e,n]))}function l(e,t){var n,r,i,o,s=be.inArray(e,a);0<=s&&a.splice(s,1),0<c.length&&(n=c.shift(),r=n[0],i=n[1],this._debug("Transport dequeued request",i.id),t?(this.getConfiguration().autoBatch&&function(e){for(;0<c.length;){var t=c[0],n=t[0],r=t[1];if(n.url!==e.url||n.sync!==e.sync)break;c.shift(),e.messages=e.messages.concat(n.messages),this._debug("Coalesced",n.messages.length,"messages from request",r.id)}}.call(this,r),u.call(this,r),this._debug("Transport completed request",e.id,r)):(o=this).setTimeout(function(){o.complete(i,!1,i.metaConnect);var e={reason:"Previous request failed"},t=i.xhr;e.httpCode=o.xhrStatus(t),r.onFailure(t,r.messages,e)},0))}return e.complete=function(e,t,n){n?function(e){var t=e.id;if(this._debug("Transport",this.getType(),"metaConnect complete, request",t),null!==o&&o.id!==t)throw new Error("Longpoll request mismatch, completing request "+t);o=null}.call(this,e):l.call(this,e,t)},e.transportSend=function(e,t){throw new Error("Abstract")},e.transportSuccess=function(e,t,n){t.expired||(this.clearTimeout(t.timeout),this.complete(t,!0,t.metaConnect),n&&0<n.length?e.onSuccess(n):e.onFailure(t.xhr,e.messages,{httpCode:204}))},e.transportFailure=function(e,t,n){t.expired||(this.clearTimeout(t.timeout),this.complete(t,!1,t.metaConnect),e.onFailure(t.xhr,e.messages,n))},e.send=function(e,t){t?function(e){if(null!==o)throw new Error("Concurrent metaConnect requests not allowed, request id="+o.id+" not yet completed");var t=++i;this._debug("Transport",this.getType(),"metaConnect send, request",t,"envelope",e);var n={id:t,metaConnect:!0,envelope:e};s.call(this,e,n),o=n}.call(this,e):u.call(this,e)},e.abort=function(){r.abort();for(var e=0;e<a.length;++e){var t=a[e];t&&(this._debug("Aborting request",t),this.abortXHR(t.xhr)||this.transportFailure(t.envelope,t,{reason:"abort"}))}var n=o;n&&(this._debug("Aborting metaConnect request",n),this.abortXHR(n.xhr)||this.transportFailure(n.envelope,n,{reason:"abort"})),this.reset(!0)},e.reset=function(e){r.reset(e),o=null,a=[],c=[]},e.abortXHR=function(e){if(e)try{var t=e.readyState;return e.abort(),t!==ve.XMLHttpRequest.UNSENT}catch(e){this._debug(e)}return!1},e.xhrStatus=function(e){if(e)try{return e.status}catch(e){this._debug(e)}return-1},e}function ye(){var t=new n,i=v.derive(t),a=!0;return i.accept=function(e,t,n){return a||!t},i.newXMLHttpRequest=function(){return new ve.XMLHttpRequest},i.xhrSend=function(e){var t=i.newXMLHttpRequest();t.context=i.context,t.withCredentials=!0,t.open("POST",e.url,!0!==e.sync);var n=e.headers;if(n)for(var r in n)n.hasOwnProperty(r)&&t.setRequestHeader(r,n[r]);return t.setRequestHeader("Content-Type","application/json;charset=UTF-8"),t.onload=function(){200===t.status?e.onSuccess(t.responseText):e.onError(t.statusText)},t.onerror=function(){e.onError(t.statusText)},t.send(e.body),t},i.transportSend=function(i,o){this._debug("Transport",this.getType(),"sending request",o.id,"envelope",i);var s=this;try{var r=!0;o.xhr=this.xhrSend({transport:this,url:i.url,sync:i.sync,headers:this.getConfiguration().requestHeaders,body:JSON.stringify(i.messages),onSuccess:function(e){s._debug("Transport",s.getType(),"received response",e);var t,n=!1;try{var r=s.convertToMessages(e);0===r.length?(a=!1,s.transportFailure(i,o,{httpCode:204})):(n=!0,s.transportSuccess(i,o,r))}catch(e){s._debug(e),n||(a=!1,(t={exception:e}).httpCode=s.xhrStatus(o.xhr),s.transportFailure(i,o,t))}},onError:function(e,t){s._debug("Transport",s.getType(),"received error",e,t),a=!1;var n={reason:e,exception:t};n.httpCode=s.xhrStatus(o.xhr),r?s.setTimeout(function(){s.transportFailure(i,o,n)},0):s.transportFailure(i,o,n)}}),r=!1}catch(e){a=!1,this.setTimeout(function(){s.transportFailure(i,o,{exception:e})},0)}},i.reset=function(e){t.reset(e),a=!0},i}function Te(){var e=new n,t=v.derive(e),o=0;function m(e,t,n){var r=this;return function(){r.transportFailure(e,t,"error",n)}}return t.accept=function(e,t,n){return!0},t.jsonpSend=function(t){var n=document.getElementsByTagName("head")[0],r=document.createElement("script"),i="_cometd_jsonp_"+o++;ve[i]=function(e){n.removeChild(r),delete ve[i],t.onSuccess(e)};var e=t.url;e+=e.indexOf("?")<0?"?":"&",e+="jsonp="+i,e+="&message="+encodeURIComponent(t.body),r.src=e,r.async=!0!==t.sync,r.type="application/javascript",r.onerror=function(e){t.onError("jsonp "+e.type)},n.appendChild(r)},t.transportSend=function(e,r){for(var i=this,t=0,n=e.messages.length,o=[];0<n;){var s=JSON.stringify(e.messages.slice(t,t+n)),a=e.url.length+encodeURI(s).length,c=this.getConfiguration().maxURILength;if(c<a){if(1===n){var u="Bayeux message too big ("+a+" bytes, max is "+c+") for transport "+this.getType();return void this.setTimeout(m.call(this,e,r,u),0)}--n}else o.push(n),t+=n,n=e.messages.length-t}var l=e;if(1<o.length){var h=o[0];this._debug("Transport",this.getType(),"split",e.messages.length,"messages into",o.join(" + ")),(l=this._mixin(!1,{},e)).messages=e.messages.slice(0,h),l.onSuccess=e.onSuccess,l.onFailure=e.onFailure;for(var f=1;f<o.length;++f){var d=this._mixin(!1,{},e),g=h;h+=o[f],d.messages=e.messages.slice(g,h),d.onSuccess=e.onSuccess,d.onFailure=e.onFailure,this.send(d,r.metaConnect)}}this._debug("Transport",this.getType(),"sending request",r.id,"envelope",l);try{var p=!0;this.jsonpSend({transport:this,url:l.url,sync:l.sync,headers:this.getConfiguration().requestHeaders,body:JSON.stringify(l.messages),onSuccess:function(e){var t=!1;try{var n=i.convertToMessages(e);0===n.length?i.transportFailure(l,r,{httpCode:204}):(t=!0,i.transportSuccess(l,r,n))}catch(e){i._debug(e),t||i.transportFailure(l,r,{exception:e})}},onError:function(e,t){var n={reason:e,exception:t};p?i.setTimeout(function(){i.transportFailure(l,r,n)},0):i.transportFailure(l,r,n)}}),p=!1}catch(e){this.setTimeout(function(){i.transportFailure(l,r,{exception:e})},0)}},t}function we(){var u,n=new v,c=v.derive(n),l=!0,h=!(c.webSocketConnected=!1),f=null,d=null,b=!1,y=null;function g(e,t){e&&(this.webSocketClose(e,t.code,t.reason),this.onClose(e,t))}function p(e){return e===d||e===f}function i(e,t,n){for(var r=[],i=0;i<t.messages.length;++i){var o=t.messages[i];o.id&&r.push(o.id)}e.envelopes[r.join(",")]=[t,n],this._debug("Transport",this.getType(),"stored envelope, envelopes",e.envelopes)}function o(t){if(!d){var e=u.getURL().replace(/^http/,"ws");this._debug("Transport",this.getType(),"connecting to URL",e);try{var n=u.getConfiguration().protocol;t.webSocket=n?new ve.WebSocket(e,n):new ve.WebSocket(e),d=t}catch(e){throw l=!1,this._debug("Exception while creating WebSocket object",e),new Error(e)}h=!1!==u.getConfiguration().stickyReconnect;var r=this,i=u.getConfiguration().connectTimeout;0<i&&(t.connectTimer=this.setTimeout(function(){u._debug("Transport",r.getType(),"timed out while connecting to URL",e,":",i,"ms"),g.call(r,t,{code:1e3,reason:"Connect Timeout"})},i));function o(e){e=e||{code:1e3},u._debug("WebSocket onclose",t,e,"connecting",d,"current",f),t.connectTimer&&r.clearTimeout(t.connectTimer),r.onClose(t,e)}t.webSocket.onopen=function(){u._debug("WebSocket onopen",t),t.connectTimer&&r.clearTimeout(t.connectTimer),p(t)?(d=null,f=t,c.webSocketConnected=!0,r.onOpen(t)):(u._warn("Closing extra WebSocket connection",this,"active connection",f),g.call(r,t,{code:1e3,reason:"Extra Connection"}))},t.webSocket.onclose=o,t.webSocket.onerror=function(){o({code:1e3,reason:"Error"})},t.webSocket.onmessage=function(e){u._debug("WebSocket onmessage",e,t),r.onMessage(t,e)},this._debug("Transport",this.getType(),"configured callbacks on",t)}}function s(n,r,e){var t=JSON.stringify(r.messages);n.webSocket.send(t),this._debug("Transport",this.getType(),"sent",r,"metaConnect =",e),this.onStat({tx:t.length});var i=this.getConfiguration().maxNetworkDelay,o=i;e&&(o+=this.getAdvice().timeout,b=!0);for(var s=this,a=[],c=0;c<r.messages.length;++c)!function(){var e,t=r.messages[c];t.id&&(a.push(t.id),e={clear:function(){e.timeout&&s.clearTimeout(e.timeout),e.timeout=null},rearm:function(){e.clear(),e.timeout=s.setTimeout(function(){u._debug("Transport",s.getType(),"timing out message",t.id,"after",o,"on",n),g.call(s,n,{code:1e3,reason:"Message Timeout"})},o)}},(n.timeouts[t.id]=e).rearm())}();this._debug("Transport",this.getType(),"waiting at most",o,"ms for messages",a,"maxNetworkDelay",i,", timeouts:",n.timeouts)}return c.reset=function(e){n.reset(e),l=!0,e&&(c.webSocketConnected=!1),d=f=null,b=!(h=!0)},c._notifySuccess=function(e,t){e.call(this,t)},c._notifyFailure=function(e,t,n,r){e.call(this,t,n,r)},c.onOpen=function(e){var t,n,r,i,o=e.envelopes;for(t in this._debug("Transport",this.getType(),"opened",e,"pending messages",o),o){o.hasOwnProperty(t)&&(r=(n=o[t])[0],i=n[1],y=r.onSuccess,s.call(this,e,r,i))}},c.onMessage=function(e,t){if(this._debug("Transport",this.getType(),"received websocket message",t,e),this.onStat({rx:t.data&&t.data.length||0}),this.getConfiguration().rearmNetworkDelayAfterMessage){var n=(new Date).getTime();if(!e._lastRearm||1e3<n-e._lastRearm)for(var r in e._lastRearm=n,e.timeouts)e.timeouts.hasOwnProperty(r)&&e.timeouts[r].rearm()}for(var i=!1,o=this.convertToMessages(t.data),s=[],a=0;a<o.length;++a){var c,u=o[a];(/^\/meta\//.test(u.channel)||void 0===u.data)&&u.id&&(s.push(u.id),(c=e.timeouts[u.id])&&(c.clear(),delete e.timeouts[u.id],this._debug("Transport",this.getType(),"removed timeout for message",u.id,", timeouts",e.timeouts))),"/meta/connect"===u.channel&&(b=!1),"/meta/disconnect"!==u.channel||b||(i=!0)}for(var l=!1,h=e.envelopes,f=0;f<s.length;++f){var d,r=s[f];for(d in h)if(h.hasOwnProperty(d)){var g=d.split(","),p=be.inArray(r,g);if(0<=p){l=!0,g.splice(p,1);var m=h[d][0],v=h[d][1];delete h[d],0<g.length&&(h[g.join(",")]=[m,v]);break}}}l&&this._debug("Transport",this.getType(),"removed envelope, envelopes",h),this._notifySuccess(y,o),i&&this.webSocketClose(e,1e3,"Disconnect")},c.onClose=function(e,t){this._debug("Transport",this.getType(),"closed",e,t),p(e)&&(l=h&&c.webSocketConnected,f=d=null);var n,r=e.timeouts;for(n in e.timeouts={},r)r.hasOwnProperty(n)&&r[n].clear();var i,o,s,a=e.envelopes;for(i in e.envelopes={},a){a.hasOwnProperty(i)&&(o=a[i][0],a[i][1]&&(b=!1),s={websocketCode:t.code,reason:t.reason},t.exception&&(s.exception=t.exception),this._notifyFailure(o.onFailure,e,o.messages,s))}},c.registered=function(e,t){n.registered(e,t),u=t},c.accept=function(e,t,n){return this._debug("Transport",this.getType(),"accept, supported:",l),l&&!!ve.WebSocket&&!1!==u.websocketEnabled},c.send=function(e,t){this._debug("Transport",this.getType(),"sending",e,"metaConnect =",t),function(t,e,n){try{null===t?(i.call(this,t=d||{envelopes:{},timeouts:{}},e,n),o.call(this,t)):(i.call(this,t,e,n),s.call(this,t,e,n))}catch(e){var r=this;this.setTimeout(function(){g.call(r,t,{code:1e3,reason:"Exception",exception:e})},0)}}.call(this,f,e,t)},c.webSocketClose=function(e,t,n){try{e.webSocket&&e.webSocket.close(t,n)}catch(e){this._debug(e)}},c.abort=function(){n.abort(),g.call(this,f,{code:1e3,reason:"Abort"}),this.reset(!0)},c.onStat=function(e){},c}var d=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z",".","-",":","+","=","^","!","/","*","?","&","<",">","(",")","[","]","{","}","@","%","$","#"],g=[0,68,0,84,83,82,72,0,75,76,70,65,0,63,62,69,0,1,2,3,4,5,6,7,8,9,64,0,73,66,74,71,81,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,77,0,78,67,0,0,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,79,0,80,0,0];return{CometD:function(e,t){var h,c,u,f=this,n=e||"default",l=!1,d=new me,r="disconnected",i=0,g=null,p=0,o=[],m=!1,v=0,b={},y=0,s=null,T=[],w={},x={},k={},a=!1,_=!1,C=0,S=0;t&&"undefined"!==t.glob&&(ve=t.glob);var E,R,I={protocol:null,stickyReconnect:!0,connectTimeout:0,maxConnections:2,backoffIncrement:1e3,maxBackoff:6e4,logLevel:"info",maxNetworkDelay:1e4,rearmNetworkDelayAfterMessage:!1,requestHeaders:{},appendMessageTypeToURL:!0,autoBatch:!1,urls:{},maxURILength:2e3,advice:{timeout:6e4,interval:0,reconnect:void 0,maxInterval:0}};function L(e,t){try{return e[t]}catch(e){return}}function A(e){return be.isString(e)}function U(e){return null!=e&&"function"==typeof e}function q(e,t){for(var n="";0<--t&&!(e>=Math.pow(10,t));)n+="0";return n+=e}function D(e,t){var n,r;!ve.console||U(n=ve.console[e])&&(r=new Date,[].splice.call(t,0,0,q(r.getHours(),2)+":"+q(r.getMinutes(),2)+":"+q(r.getSeconds(),2)+"."+q(r.getMilliseconds(),3)),n.apply(ve.console,t))}function F(e){return/(^https?:\/\/)?(((\[[^\]]+\])|([^:\/\?#]+))(:(\d+))?)?([^\?#]*)(.*)?/.exec(e)}function B(e){var t;!e||(t=b[e.channel])&&t[e.id]&&(delete t[e.id],f._debug("Removed",e.listener?"listener":"subscription",e))}function O(e){e&&!e.listener&&B(e)}function M(){for(var e in b)if(b.hasOwnProperty(e)){var t=b[e];if(t)for(var n in t)t.hasOwnProperty(n)&&O(t[n])}}function N(e){r!==e&&(f._debug("Status",r,"->",e),r=e)}function P(){return"disconnecting"===r||"disconnected"===r}function j(){return""+ ++i}function H(e,t,n,r,i){try{return t.call(e,r)}catch(e){var o=f.onExtensionException;if(U(o)){f._debug("Invoking extension exception handler",n,e);try{o.call(f,e,n,i,r)}catch(e){f._info("Exception during execution of extension exception handler",n,e)}}else f._info("Exception during execution of extension",n,e);return r}}function W(e,t){var n=b[e];if(n)for(var r in n)if(n.hasOwnProperty(r)){var i=n[r];if(i)try{i.callback.call(i.scope,t)}catch(e){var o=f.onListenerException;if(U(o)){f._debug("Invoking listener exception handler",i,e);try{o.call(f,e,i,i.listener,t)}catch(e){f._info("Exception during execution of listener exception handler",i,e)}}else f._info("Exception during execution of listener",i,t,e)}}}function X(e,t){W(e,t);for(var n=e.split("/"),r=n.length-1,i=r;0<i;--i){var o=n.slice(0,i).join("/")+"/*";i===r&&W(o,t),W(o+="*",t)}}function J(){null!==s&&be.clearTimeout(s),s=null}function Z(e,t){J();var n=w.interval+t;f._debug("Function scheduled in",n,"ms, interval =",w.interval,"backoff =",y,e),s=be.setTimeout(f,e,n)}function V(e,t,n,r){for(var i,o,s=0;s<t.length;++s){var a=t[s],c=a.id;g&&(a.clientId=g),null!=(a=function(e){for(var t=T.length-1;0<=t&&null!=e;--t){var n,r=T[t],i=r.extension.outgoing;U(i)&&(e=void 0===(n=H(r.extension,i,r.name,e,!0))?e:n)}return e}(a))?(a.id=c,t[s]=a):(delete x[c],t.splice(s--,1))}0!==t.length&&(i=f.getURL(),I.appendMessageTypeToURL&&(i.match(/\/$/)||(i+="/"),r&&(i+=r)),o={url:i,sync:e,messages:t,onSuccess:function(e){try{E.call(f,e)}catch(e){f._info("Exception during handling of messages",e)}},onFailure:function(e,t,n){try{var r=f.getTransport();n.connectionType=r?r.getType():"unknown",R.call(f,e,t,n)}catch(e){f._info("Exception during handling of failure",e)}}},f._debug("Send",o),h.send(o,n))}function z(e){0<p||!0===m?o.push(e):V(!1,[e],!1)}function $(){y=0}function G(){var e=o;o=[],0<e.length&&V(!1,e,!1)}function K(e){N("connecting"),Z(function(){var e;P()||(e={id:j(),channel:"/meta/connect",connectionType:h.getType()},_||(e.advice={timeout:0}),N("connecting"),f._debug("Connect sent",e),V(!1,[e],!0,"connect"),N("connected"))},e)}function Q(e){e&&(w=f._mixin(!1,{},I.advice,e),f._debug("New advice",w))}function Y(e){var t;J(),e&&h&&h.abort(),g=null,N("disconnected"),p=0,$(),h=null,_=a=!1,0<o.length&&(t=o,o=[],R.call(f,void 0,t,{reason:"Disconnected"}))}function ee(e,t,n){var r=f.onTransportException;if(U(r)){f._debug("Invoking transport exception handler",e,t,n);try{r.call(f,n,e,t)}catch(e){f._info("Exception during execution of transport exception handler",e)}}}function te(e,t){U(e)&&(t=e,e=void 0),g=null,M(),P()&&d.reset(!0),Q({}),m=!(p=0),c=e,u=t;var n="1.0",r=f.getURL(),i=d.findTransportTypes(n,l,r),o={id:j(),version:n,minimumVersion:n,channel:"/meta/handshake",supportedConnectionTypes:i,advice:{timeout:w.timeout,interval:w.interval}},s=f._mixin(!1,{},c,o);if(f._putCallback(s.id,t),!h&&!(h=d.negotiateTransport(i,n,l,r))){var a="Could not find initial transport among: "+d.getTransportTypes();throw f._warn(a),new Error(a)}f._debug("Initial transport is",h.getType()),N("handshaking"),f._debug("Handshake sent",s),V(!1,[s],!1,"handshake")}function ne(e,t){try{e.call(f,t)}catch(e){var n=f.onCallbackException;if(U(n)){f._debug("Invoking callback exception handler",e);try{n.call(f,e,t)}catch(e){f._info("Exception during execution of callback exception handler",e)}}else f._info("Exception during execution of message callback",e)}}function re(e){var t=f._getCallback([e.id]);U(t)&&(delete x[e.id],ne(t,e))}function ie(e){var t=k[e.id];if(delete k[e.id],t){f._debug("Handling remote call response for",e,"with context",t);var n=t.timeout;n&&be.clearTimeout(n);var r=t.callback;if(U(r))return ne(r,e),1}}function oe(e){f._debug("Transport failure handling",e),e.transport&&(h=e.transport),e.url&&h.setURL(e.url);var t,n=e.action,r=e.delay||0;switch(n){case"handshake":t=r,N("handshaking"),m=!0,Z(function(){te(c,u)},t);break;case"retry":K(r);break;case"none":Y(!0);break;default:throw new Error("Unknown action "+n)}}function se(e,t){re(e),X("/meta/handshake",e),X("/meta/unsuccessful",e),P()&&(t.action="none"),f.onTransportFailure.call(f,e,t,oe)}function ae(e,t){X("/meta/connect",e),X("/meta/unsuccessful",e),P()&&(t.action="none"),f.onTransportFailure.call(f,e,t,oe)}function ce(e){Y(!0),re(e),X("/meta/disconnect",e),X("/meta/unsuccessful",e)}function ue(e){var t,n=b[e.subscription];if(n)for(var r in n){!n.hasOwnProperty(r)||(t=n[r])&&!t.listener&&(delete n[r],f._debug("Removed failed subscription",t))}re(e),X("/meta/subscribe",e),X("/meta/unsuccessful",e)}function le(e){re(e),X("/meta/unsubscribe",e),X("/meta/unsuccessful",e)}function he(e){ie(e)||(re(e),X("/meta/publish",e),X("/meta/unsuccessful",e))}function fe(e){var t,n,r,i;if(C=0,null!=(e=function(e){for(var t=0;t<T.length&&null!=e;++t){var n,r=T[t],i=r.extension.incoming;U(i)&&(e=void 0===(n=H(r.extension,i,r.name,e,!1))?e:n)}return e}(e)))switch(Q(e.advice),e.channel){case"/meta/handshake":!function(e){var t=f.getURL();if(e.successful){var n=f._isCrossDomain(F(t)[2]),r=d.negotiateTransport(e.supportedConnectionTypes,e.version,n,t);if(null===r)return e.successful=!1,se(e,{cause:"negotiation",action:"none",transport:null});h!==r&&(f._debug("Transport",h.getType(),"->",r.getType()),h=r),g=e.clientId,m=!1,G(),e.reestablish=a,a=!0,re(e),X("/meta/handshake",e),S=e["x-messages"]||0;var i=P()?"none":w.reconnect||"retry";switch(i){case"retry":$(),0===S?K(0):f._debug("Processing",S,"handshake-delivered messages");break;case"none":Y(!0);break;default:throw new Error("Unrecognized advice action "+i)}}else se(e,{cause:"unsuccessful",action:w.reconnect||"handshake",transport:h})}(e);break;case"/meta/connect":!function(e){if(_=e.successful){X("/meta/connect",e);var t=P()?"none":w.reconnect||"retry";switch(t){case"retry":$(),K(y);break;case"none":Y(!1);break;default:throw new Error("Unrecognized advice action "+t)}}else ae(e,{cause:"unsuccessful",action:w.reconnect||"retry",transport:h})}(e);break;case"/meta/disconnect":(i=e).successful?(Y(!1),re(i),X("/meta/disconnect",i)):ce(i);break;case"/meta/subscribe":(r=e).successful?(re(r),X("/meta/subscribe",r)):ue(r);break;case"/meta/unsubscribe":(n=e).successful?(re(n),X("/meta/unsubscribe",n)):le(n);break;default:void 0!==(t=e).data?ie(t)||(X(t.channel,t),0<S&&0===--S&&(f._debug("Processed last handshake-delivered message"),K(0))):void 0===t.successful?f._warn("Unknown Bayeux Message",t):t.successful?(re(t),X("/meta/publish",t)):he(t)}}function de(e){var t=b[e];if(t)for(var n in t)if(t.hasOwnProperty(n)&&t[n])return 1}function ge(e,t){var n={scope:e,method:t};if(U(e))n.scope=void 0,n.method=e;else if(A(t)){if(!e)throw new Error("Invalid scope "+e);if(n.method=e[t],!U(n.method))throw new Error("Invalid callback "+t+" for scope "+e)}else if(!U(t))throw new Error("Invalid callback "+t);return n}function pe(e,t,n,r){var i=ge(t,n);f._debug("Adding",r?"listener":"subscription","on",e,"with scope",i.scope,"and callback",i.method);var o=++v,s={id:o,channel:e,scope:i.scope,callback:i.method,listener:r},a=b[e];return a||(a={},b[e]=a),a[o]=s,f._debug("Added",r?"listener":"subscription",s),s}this._mixin=function(e,t,n){for(var r=t||{},i=2;i<arguments.length;++i){var o=arguments[i];if(null!=o)for(var s in o)if(o.hasOwnProperty(s)){var a,c=L(o,s),u=L(r,s);if(c===t)continue;if(void 0===c)continue;e&&"object"==typeof c&&null!==c?c instanceof Array?r[s]=this._mixin(e,u instanceof Array?u:[],c):(a="object"!=typeof u||u instanceof Array?{}:u,r[s]=this._mixin(e,a,c)):r[s]=c}}return r},this._warn=function(){D("warn",arguments)},this._info=function(){"warn"!==I.logLevel&&D("info",arguments)},this._debug=function(){"debug"===I.logLevel&&D("debug",arguments)},this._isCrossDomain=function(e){return!!(ve.location&&ve.location.host&&e)&&e!==ve.location.host},this.send=z,this._getCallback=function(e){return x[e]},this._putCallback=function(e,t){var n=this._getCallback(e);return U(t)&&(x[e]=t),n},this.onTransportFailure=function(e,t,n){this._debug("Transport failure",t,"for",e);var r,i,o,s,a=this.getTransportRegistry(),c=this.getURL(),u=this._isCrossDomain(F(c)[2]),l=a.findTransportTypes("1.0",u,c);"none"===t.action?"/meta/handshake"===e.channel&&(t.transport||(r="Could not negotiate transport, client=["+l+"], server=["+e.supportedConnectionTypes+"]",this._warn(r),h&&ee(h.getType(),null,{reason:r,connectionType:h.getType(),transport:h}))):(t.delay=this.getBackoffPeriod(),"/meta/handshake"===e.channel?(t.transport||((i=a.negotiateTransport(l,"1.0",u,c))?(h&&(this._debug("Transport",h.getType(),"->",i.getType()),ee(h.getType(),i.getType(),e.failure)),t.action="handshake",t.transport=i):(this._warn("Could not negotiate transport, client=["+l+"]"),h&&ee(h.getType(),null,e.failure),t.action="none")),"none"!==t.action&&this.increaseBackoffPeriod()):(o=(new Date).getTime(),0===C&&(C=o),"retry"===t.action&&(t.delay=this.increaseBackoffPeriod(),0<(s=w.maxInterval)&&w.timeout+w.interval+s<o-C+y&&(t.action="handshake")),"handshake"===t.action&&(t.delay=0,a.reset(!1),this.resetBackoffPeriod()))),n.call(f,t)},this.receive=fe,E=function(e){f._debug("Received",e);for(var t=0;t<e.length;++t){fe(e[t])}},R=function(e,t,n){f._debug("handleFailure",e,t,n),n.transport=e;for(var r=0;r<t.length;++r){var i=t[r],o={id:i.id,successful:!1,channel:i.channel,failure:n};switch((n.message=i).channel){case"/meta/handshake":se(o,{cause:"failure",action:"handshake",transport:null});break;case"/meta/connect":_=!1,ae(o,{cause:"failure",action:"retry",transport:null});break;case"/meta/disconnect":ce(o);break;case"/meta/subscribe":o.subscription=i.subscription,ue(o);break;case"/meta/unsubscribe":o.subscription=i.subscription,le(o);break;default:he(o)}}},this.registerTransport=function(e,t,n){var r=d.add(e,t,n);return r&&(this._debug("Registered transport",e),U(t.registered)&&t.registered(e,this)),r},this.unregisterTransport=function(e){var t=d.remove(e);return null!==t&&(this._debug("Unregistered transport",e),U(t.unregistered)&&t.unregistered()),t},this.unregisterTransports=function(){d.clear()},this.getTransportTypes=function(){return d.getTransportTypes()},this.findTransport=function(e){return d.find(e)},this.getTransportRegistry=function(){return d},this.configure=function(e){(function(e){f._debug("Configuring cometd object with",e),A(e)&&(e={url:e}),e=e||{},I=f._mixin(!1,I,e);var t=f.getURL();if(!t)throw new Error("Missing required configuration parameter 'url' specifying the Bayeux server URL");var n,r,i=F(t),o=i[2],s=i[8],a=i[9];l=f._isCrossDomain(o),I.appendMessageTypeToURL&&(void 0!==a&&0<a.length?(f._info("Appending message type to URI "+s+a+" is not supported, disabling 'appendMessageTypeToURL' configuration"),I.appendMessageTypeToURL=!1):(r=(n=s.split("/")).length-1,s.match(/\/$/)&&--r,0<=n[r].indexOf(".")&&(f._info("Appending message type to URI "+s+" is not supported, disabling 'appendMessageTypeToURL' configuration"),I.appendMessageTypeToURL=!1)))}).call(this,e)},this.init=function(e,t){this.configure(e),this.handshake(t)},this.handshake=function(e,t){if("disconnected"!==r)throw new Error("Illegal state: handshaken");te(e,t)},this.disconnect=function(e,t,n){var r,i;P()?n&&n():("boolean"!=typeof e&&(n=t,t=e,e=!1),U(t)&&(n=t,t=void 0),r={id:j(),channel:"/meta/disconnect"},i=this._mixin(!1,{},t,r),f._putCallback(i.id,n),N("disconnecting"),V(!0===e,[i],!1,"disconnect"))},this.startBatch=function(){++p,f._debug("Starting batch, depth",p)},this.endBatch=function(){!function(){if(--p,f._debug("Ending batch, depth",p),p<0)throw new Error("Calls to startBatch() and endBatch() are not paired");0!==p||P()||m||G()}()},this.batch=function(e,t){var n=ge(e,t);this.startBatch();try{n.method.call(n.scope),this.endBatch()}catch(e){throw this._info("Exception during execution of batch",e),this.endBatch(),new Error(e)}},this.addListener=function(e,t,n){if(arguments.length<2)throw new Error("Illegal arguments number: required 2, got "+arguments.length);if(!A(e))throw new Error("Illegal argument type: channel must be a string");return pe(e,t,n,!0)},this.removeListener=function(e){if(!(e&&e.channel&&"id"in e))throw new Error("Invalid argument: expected subscription, not "+e);B(e)},this.clearListeners=function(){b={}},this.subscribe=function(e,t,n,r,i){if(arguments.length<2)throw new Error("Illegal arguments number: required 2, got "+arguments.length);if(!A(e))throw new Error("Illegal argument type: channel must be a string");if(P())throw new Error("Illegal state: disconnected");U(t)&&(i=r,r=n,n=t,t=void 0),U(r)&&(i=r,r=void 0);var o,s,a=!de(e),c=pe(e,t,n,!1);return a&&(o={id:j(),channel:"/meta/subscribe",subscription:e},s=this._mixin(!1,{},r,o),f._putCallback(s.id,i),z(s)),c},this.unsubscribe=function(e,t,n){if(arguments.length<1)throw new Error("Illegal arguments number: required 1, got "+arguments.length);if(P())throw new Error("Illegal state: disconnected");U(t)&&(n=t,t=void 0),this.removeListener(e);var r,i,o=e.channel;de(o)||(r={id:j(),channel:"/meta/unsubscribe",subscription:o},i=this._mixin(!1,{},t,r),f._putCallback(i.id,n),z(i))},this.resubscribe=function(e,t){if(O(e),e)return this.subscribe(e.channel,e.scope,e.callback,t)},this.clearSubscriptions=function(){M()},this.publish=function(e,t,n,r){if(arguments.length<1)throw new Error("Illegal arguments number: required 1, got "+arguments.length);if(!A(e))throw new Error("Illegal argument type: channel must be a string");if(/^\/meta\//.test(e))throw new Error("Illegal argument: cannot publish to meta channels");if(P())throw new Error("Illegal state: disconnected");U(t)?(r=t,t={},n=void 0):U(n)&&(r=n,n=void 0);var i={id:j(),channel:e,data:t},o=this._mixin(!1,{},n,i);f._putCallback(o.id,r),z(o)},this.publishBinary=function(e,t,n,r,i){U(t)?(i=t,t=new ArrayBuffer(0),n=!0,r=void 0):U(n)?(i=n,n=!0,r=void 0):U(r)&&(i=r,r=void 0);var o={meta:r,data:t,last:n};this.publish(e,o,{ext:{binary:{}}},i)},this.remoteCall=function(e,t,n,r,i){if(arguments.length<1)throw new Error("Illegal arguments number: required 1, got "+arguments.length);if(!A(e))throw new Error("Illegal argument type: target must be a string");if(P())throw new Error("Illegal state: disconnected");if(U(t)?(i=t,t={},n=I.maxNetworkDelay,r=void 0):U(n)?(i=n,n=I.maxNetworkDelay,r=void 0):U(r)&&(i=r,r=void 0),"number"!=typeof n)throw new Error("Illegal argument type: timeout must be a number");e.match(/^\//)||(e="/"+e);var o={id:j(),channel:"/service"+e,data:t},s=this._mixin(!1,{},r,o),a={callback:i};0<n&&(a.timeout=be.setTimeout(f,function(){f._debug("Timing out remote call",s,"after",n,"ms"),he({id:s.id,error:"406::timeout",successful:!1,failure:{message:s,reason:"Remote Call Timeout"}})},n),f._debug("Scheduled remote call timeout",s,"in",n,"ms")),k[s.id]=a,z(s)},this.remoteCallBinary=function(e,t,n,r,i,o){U(t)?(o=t,t=new ArrayBuffer(0),n=!0,r=void 0,i=I.maxNetworkDelay):U(n)?(o=n,n=!0,r=void 0,i=I.maxNetworkDelay):U(r)?(o=r,r=void 0,i=I.maxNetworkDelay):U(i)&&(o=i,i=I.maxNetworkDelay);var s={meta:r,data:t,last:n};this.remoteCall(e,s,i,{ext:{binary:{}}},o)},this.getStatus=function(){return r},this.isDisconnected=P,this.setBackoffIncrement=function(e){I.backoffIncrement=e},this.getBackoffIncrement=function(){return I.backoffIncrement},this.getBackoffPeriod=function(){return y},this.increaseBackoffPeriod=function(){return y<I.maxBackoff&&(y+=I.backoffIncrement),y},this.resetBackoffPeriod=function(){$()},this.setLogLevel=function(e){I.logLevel=e},this.registerExtension=function(e,t){if(arguments.length<2)throw new Error("Illegal arguments number: required 2, got "+arguments.length);if(!A(e))throw new Error("Illegal argument type: extension name must be a string");for(var n=!1,r=0;r<T.length;++r){if(T[r].name===e){n=!0;break}}return n?(this._info("Could not register extension with name",e,"since another extension with the same name already exists"),!1):(T.push({name:e,extension:t}),this._debug("Registered extension",e),U(t.registered)&&t.registered(e,this),!0)},this.unregisterExtension=function(e){if(!A(e))throw new Error("Illegal argument type: extension name must be a string");for(var t=!1,n=0;n<T.length;++n){var r=T[n];if(r.name===e){T.splice(n,1),t=!0,this._debug("Unregistered extension",e);var i=r.extension;U(i.unregistered)&&i.unregistered();break}}return t},this.getExtension=function(e){for(var t=0;t<T.length;++t){var n=T[t];if(n.name===e)return n.extension}return null},this.getName=function(){return n},this.getClientId=function(){return g},this.getURL=function(){if(h){var e=h.getURL();if(e)return e;if(e=I.urls[h.getType()])return e}return I.url},this.getTransport=function(){return h},this.getConfiguration=function(){return this._mixin(!0,{},I)},this.getAdvice=function(){return this._mixin(!0,{},w)},t&&t.noDefaultTransports||(ve.WebSocket&&this.registerTransport("websocket",new we),this.registerTransport("long-polling",new ye),this.registerTransport("callback-polling",new Te))},Transport:v,RequestTransport:n,LongPollingTransport:ye,CallbackPollingTransport:Te,WebSocketTransport:we,Utils:be,Z85:{encode:function(e){var t=null;if(e instanceof ArrayBuffer?t=e:e.buffer instanceof ArrayBuffer?t=e.buffer:Array.isArray(e)&&(t=new Uint8Array(e).buffer),null==t)throw new Error("Cannot Z85 encode "+e);for(var n=t.byteLength,r=n%4,i=4-(0==r?4:r),o=new DataView(t),s="",a=0,c=0;c<n+i;++c){var u=n<=c,a=256*a+(u?0:o.getUint8(c));if((c+1)%4==0){for(var l,h=52200625,f=5;0<f;--f){(!u||i<f)&&(l=Math.floor(a/h)%85,s+=d[l]),h/=85}a=0}}return s},decode:function(e){for(var t=e.length%5,n=5-(0==t?5:t),r=0;r<n;++r)e+=d[d.length-1];for(var i=e.length,o=new ArrayBuffer(4*i/5-n),s=new DataView(o),a=0,c=0,u=0,l=0;l<i;++l){var h=e.charCodeAt(c++)-32,a=85*a+g[h];if(c%5==0){for(var f=16777216;1<=f;)u<s.byteLength&&s.setUint8(u++,Math.floor(a/f)%256),f/=256;a=0}}return o}}}},"function"==typeof c&&c.amd?c([],t):(e.org=e.org||{},e.org.cometd=t()),n=this,r=function(e){return e.AckExtension=function(){var n,o,s=!1;function a(e,t){n._debug(e,t)}this.registered=function(e,t){n=t,a("AckExtension: executing registration callback")},this.unregistered=function(){a("AckExtension: executing unregistration callback"),n=null},this.incoming=function(e){var t,n,r=e.channel,i=e.ext;return"/meta/handshake"===r?(i&&("object"==typeof(t=i.ack)?(s=!0===t.enabled,"number"==typeof(n=t.batch)&&(o=n)):s=!0===t),a("AckExtension: server supports acknowledgements",s)):"/meta/connect"===r&&e.successful&&s&&i&&"number"==typeof i.ack&&a("AckExtension: server sent batch",o=i.ack),e},this.outgoing=function(e){var t=e.channel;return e.ext||(e.ext={}),"/meta/handshake"===t?(e.ext.ack=n&&!1!==n.ackEnabled,s=!1,o=0):"/meta/connect"===t&&s&&a("AckExtension: client sending batch",e.ext.ack=o),e}}},"function"==typeof c&&c.amd?c(["./cometd"],r):r(n.org.cometd),i=this,o=function(i){return i.TimeSyncExtension=function(e){var r,u=e&&e.maxSamples||10,l=[],h=[],f=0,d=0;function g(e,t){r._debug(e,t)}this.registered=function(e,t){r=t,g("TimeSyncExtension: executing registration callback")},this.unregistered=function(){g("TimeSyncExtension: executing unregistration callback"),r=null,l=[],h=[]},this.incoming=function(e){var t=e.channel;if(t&&0===t.indexOf("/meta/")&&e.ext&&e.ext.timesync){var n=e.ext.timesync;g("TimeSyncExtension: server sent timesync",n);var r=((new Date).getTime()-n.tc-n.p)/2,i=n.ts-n.tc-r;l.push(r),h.push(i),h.length>u&&(h.shift(),l.shift());for(var o=h.length,s=0,a=0,c=0;c<o;++c)s+=l[c],a+=h[c];f=parseInt((s/o).toFixed()),d=parseInt((a/o).toFixed()),g("TimeSyncExtension: network lag",f)}return e},this.outgoing=function(e){var t=e.channel;return t&&0===t.indexOf("/meta/")&&(e.ext||(e.ext={}),e.ext.timesync={tc:(new Date).getTime(),l:f,o:d},g("TimeSyncExtension: client sending timesync",e.ext.timesync)),e},this.getTimeOffset=function(){return d},this.getTimeOffsetSamples=function(){return h},this.getNetworkLag=function(){return f},this.getServerTime=function(){return(new Date).getTime()+d},this.getServerDate=function(){return new Date(this.getServerTime())},this.setTimeout=function(e,t){var n=(t instanceof Date?t.getTime():0+t)-d-(new Date).getTime();return n<=0&&(n=1),i.Utils.setTimeout(r,e,n)}}},"function"==typeof c&&c.amd?c(["./cometd"],o):o(i.org.cometd),s=this,a=function(n){return n.BinaryExtension=function(){this.incoming=function(e){var t;return/^\/meta\//.test(e.channel)||(t=e.ext)&&t.binary&&(e.data.data=n.Z85.decode(e.data.data)),e},this.outgoing=function(e){var t;return/^\/meta\//.test(e.channel)||(t=e.ext)&&t.binary&&(e.data.data=n.Z85.encode(e.data.data)),e}}},"function"==typeof c&&c.amd?c(["./cometd"],a):a(s.org.cometd),org.cometd});